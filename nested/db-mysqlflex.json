{
    "$schema": "http://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "moodleCommon": {
          "metadata": {
              "description": "Common Moodle values"
          },
          "type": "object"
      },
      "lbPubIp": {
        "metadata": {
            "description": "Public IP address of the deployed load balancer"
        },
        "type": "string"
      },
      "lbOut001PubIp": {
          "metadata": {
              "description": "Outgoing Public IP address of the deployed load balancer"
          },
          "type": "string"
      },
      "lbOut002PubIp": {
          "metadata": {
              "description": "Outgoing Public IP address of the deployed load balancer"
          },
          "type": "string"
      },
      "ctlrPubIp": {
          "metadata": {
              "description": "Public IP address of the deployed controller VM"
          },
          "type": "string"
      },
      "subnetIdDb": {
          "metadata": {
              "description": "Azure resource ID of the subnet where the Db is to be deployed.(if deployed in vnet)"
          },
          "type": "string"
      },
      "availabilityZone": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "Availability Zone information of the server. (Leave blank for No Preference)."
        }
      },
      "standbyAvailabilityZone": {
        "type": "string",
        "defaultValue": "",
        "metadata": {
          "description": "Availability zone of the standby server."
        }
      }
    },
    "resources": [
      {
        "type": "Microsoft.DBforMySQL/flexibleServers",
        "apiVersion": "2021-05-01",
        "location": "[parameters('moodleCommon').location]",
        "name": "[parameters('moodleCommon').serverName]",
        "sku": {
          "name": "[parameters('moodleCommon').mysqlflexSkuName]",
          "tier": "[parameters('moodleCommon').mysqlflexSkuTier]"
        },
        "properties": {
          "version": "[parameters('moodleCommon').mysqlVersion]",
          "administratorLogin": "[parameters('moodleCommon').dbLogin]",
          "administratorLoginPassword": "[parameters('moodleCommon').dbLoginPassword]",
          "availabilityZone": "[parameters('availabilityZone')]",
          "highAvailability": {
            "mode": "[parameters('moodleCommon').mysqlflexHaEnabled]",
            "standbyAvailabilityZone": "[parameters('standbyAvailabilityZone')]"
          },
          "Storage": {
            "storageSizeGB": "[parameters('moodleCommon').mysqlflexStgSizeGiB]",
            "iops": "[parameters('moodleCommon').mysqlflexStgIops]",
            "autogrow": "[parameters('moodleCommon').mysqlflexStgAutogrow]",
            "AutoIoScaling": "[parameters('moodleCommon').mysqlflexAutoIoScaling]"
          },
          "network": {
            "delegatedSubnetResourceId": "[parameters('subnetIdDb')]"
          },
          "Backup": {
            "backupRetentionDays": "35",
            "geoRedundantBackup": "Enabled"
          }
        }
      },
      {
        "type": "Microsoft.DBforMySQL/flexibleServers/configurations",
        "apiVersion": "2021-05-01",
        "name": "[concat(parameters('moodleCommon').serverName, '/require_secure_transport')]",
        "dependsOn": [
            "[concat('Microsoft.DBforMySQL/flexibleServers/', parameters('moodleCommon').serverName)]"
        ],
        "properties": {
          "value": "[parameters('moodleCommon').mysqlflexRequireSecureTransport]",
          "source": "user-override"
        }
      }
    ],
    "outputs": {
      "dbFQDN": {
          "type": "string",
          "value": "[reference(parameters('moodleCommon').serverName).fullyQualifiedDomainName]"
      }
    }
}